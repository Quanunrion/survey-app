<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locks Survey - Optimized</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/uuid@9.0.1/dist/umd/uuid.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="root" className="min-h-screen bg-gray-100 p-2 sm:p-4"></div>
    <script type="text/babel">
        // Use destructuring to import React features
        const { useState, useEffect, useRef, useCallback, useMemo, memo, createContext, useContext } = React;

        // Constants - moved outside component scope
        const lockTypes = ['Mortise', 'Cylindrical', 'Deadbolt', 'Exit Device', 'Electrified'];
        const lockFunctions = ['Storeroom', 'Office', 'Classroom', 'Entrance', 'Privacy', 'Passage'];
        const handingOptions = ['Left Hand (LH)', 'Right Hand (RH)', 'Left Hand Reverse (LHR)', 'Right Hand Reverse (RHR)'];
        const finishes = ['626 Satin Chrome', '605 Bright Brass', '612 Satin Bronze', '613 Oil Rubbed Bronze', '625 Bright Chrome'];
        const keyways = ['Schlage C', 'Schlage E', 'Yale GA', 'Corbin 60', 'None'];
        const doorTypes = ['Wood', 'Metal', 'Glass', 'Hollow Core'];
        const doorThicknesses = ['1-3/8"', '1-3/4"', '2"', '2-1/4"'];
        const backsets = ['2-3/4"', '2-3/8"', '5"'];
        const keyingOptions = ['Keyed Different (KD)', 'Keyed Alike (KA)', 'Master Keyed (MK)', 'None'];
        const fireRatings = ['None', '20 Min', '45 Min', '60 Min', '90 Min'];
        const adaOptions = ['Compliant', 'Non-Compliant'];
        const leverStyles = ['Rhodes', 'Athens', 'Sparta', 'Tubular', 'None'];

        // File utilities - moved outside and reorganized
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        
        function loadFileData(filename) {
          if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
              var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
              var firstSheetName = workbook.SheetNames[0];
              var worksheet = workbook.Sheets[firstSheetName];
              var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
              var filteredData = jsonData.filter(row => row.some(filledCell));
              var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
              );
              if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
              }
              var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
              csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
              return csv;
            } catch (e) {
              console.error(e);
              return "";
            }
          }
          return gk_fileData[filename] || "";
        }

        // UUID fallback function - More efficient implementation
        const generateFallbackId = () => {
          return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        };
        
        const uuidv4 = window.uuidv4 || generateFallbackId;

        // Create context for project state to avoid prop drilling
        const ProjectContext = createContext();

        // Default lock template - moved outside to avoid recreation on each render
        const defaultLock = {
          name: '',
          lockType: 'Mortise',
          lockFunction: 'Storeroom',
          handing: 'Left Hand (LH)',
          finish: '626 Satin Chrome',
          keyway: 'Schlage C',
          doorType: 'Wood',
          doorThickness: '1-3/4"',
          backset: '2-3/4"',
          keying: 'Keyed Different (KD)',
          fireRating: 'None',
          adaCompliance: 'Compliant',
          leverStyle: 'Rhodes',
          notes: ''
        };

        // Default room template - moved outside
        const createDefaultRoom = () => ({
          name: '',
          control4: {
            isEquipmentRoom: false,
            videoStream: { enabled: false, notes: '' },
            roomAudio: { enabled: false, wireless: false, speakers: 2, distribution: 'Stereo', notes: '' },
            keypads: [],
            lights: { enabled: false, count: 0, devices: [] },
            shades: [],
            touchscreens: [],
            haloRemote: { enabled: false, color: 'Black', notes: '' }
          },
          locks: {
            enabled: true,
            locks: [{ ...defaultLock }]
          },
          lighting: { banks: [] }
        });

        // Custom hook for local storage persistence
        const useLocalStorage = (key, initialValue) => {
          const [storedValue, setStoredValue] = useState(() => {
            try {
              const item = localStorage.getItem(key);
              return item ? JSON.parse(item) : initialValue;
            } catch (error) {
              console.error('Failed to load from localStorage:', error);
              return initialValue;
            }
          });

          useEffect(() => {
            try {
              localStorage.setItem(key, JSON.stringify(storedValue));
            } catch (error) {
              console.error('Failed to save to localStorage:', error);
            }
          }, [key, storedValue]);

          return [storedValue, setStoredValue];
        };

        // Memoized SelectField component
        const SelectField = memo(({ label, value, options, onChange, className = "border p-3 rounded w-full" }) => (
          <div>
            <label className="block text-sm font-medium mb-1">{label}</label>
            <select value={value} onChange={onChange} className={className}>
              {options.map((option) => (
                <option key={option} value={option}>{option}</option>
              ))}
            </select>
          </div>
        ));

        // Optimize LockDetails component
        const LockDetails = memo(({ locks, updateLocks }) => {
          const handleEnabledChange = useCallback((e) => {
            updateLocks({ ...locks, enabled: e.target.checked });
          }, [locks, updateLocks]);

          const updateLock = useCallback((lockIdx, field, value) => {
            const newLocks = [...locks.locks];
            newLocks[lockIdx] = { ...newLocks[lockIdx], [field]: value };
            updateLocks({ ...locks, locks: newLocks });
          }, [locks, updateLocks]);

          const deleteLock = useCallback((lockIdx) => {
            const newLocks = locks.locks.filter((_, i) => i !== lockIdx);
            updateLocks({ ...locks, locks: newLocks });
          }, [locks, updateLocks]);

          const addLock = useCallback(() => {
            updateLocks({
              ...locks,
              locks: [...locks.locks, { ...defaultLock }]
            });
          }, [locks, updateLocks]);

          return (
            <div className="mt-2">
              <label className="flex items-center mb-2">
                <input
                  type="checkbox"
                  checked={locks.enabled}
                  onChange={handleEnabledChange}
                  className="mr-2"
                />
                Enable Locks for this Room
              </label>
              {locks.enabled && (
                <div>
                  {locks.locks.map((lock, lockIdx) => (
                    <LockItem 
                      key={lockIdx}
                      lock={lock}
                      lockIdx={lockIdx}
                      updateLock={updateLock}
                      deleteLock={deleteLock}
                    />
                  ))}
                  <button
                    className="mt-2 bg-blue-400 text-white px-3 py-1 rounded hover:bg-blue-500"
                    onClick={addLock}
                  >
                    + Add Lock
                  </button>
                </div>
              )}
            </div>
          );
        });

        // Extracted LockItem component for better performance
        const LockItem = memo(({ lock, lockIdx, updateLock, deleteLock }) => (
          <div className="ml-4 mt-2 p-4 bg-gray-100 rounded">
            <input
              type="text"
              value={lock.name}
              onChange={(e) => updateLock(lockIdx, 'name', e.target.value)}
              placeholder={`Lock ${lockIdx + 1}`}
              className="border p-3 rounded w-full mb-2"
            />
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <SelectField
                label="Lock Type"
                value={lock.lockType}
                options={lockTypes}
                onChange={(e) => updateLock(lockIdx, 'lockType', e.target.value)}
              />
              <SelectField
                label="Lock Function"
                value={lock.lockFunction}
                options={lockFunctions}
                onChange={(e) => updateLock(lockIdx, 'lockFunction', e.target.value)}
              />
              <SelectField
                label="Handing"
                value={lock.handing}
                options={handingOptions}
                onChange={(e) => updateLock(lockIdx, 'handing', e.target.value)}
              />
              <SelectField
                label="Finish"
                value={lock.finish}
                options={finishes}
                onChange={(e) => updateLock(lockIdx, 'finish', e.target.value)}
              />
              <SelectField
                label="Keyway"
                value={lock.keyway}
                options={keyways}
                onChange={(e) => updateLock(lockIdx, 'keyway', e.target.value)}
              />
              <SelectField
                label="Door Type"
                value={lock.doorType}
                options={doorTypes}
                onChange={(e) => updateLock(lockIdx, 'doorType', e.target.value)}
              />
              <SelectField
                label="Door Thickness"
                value={lock.doorThickness}
                options={doorThicknesses}
                onChange={(e) => updateLock(lockIdx, 'doorThickness', e.target.value)}
              />
              <SelectField
                label="Backset"
                value={lock.backset}
                options={backsets}
                onChange={(e) => updateLock(lockIdx, 'backset', e.target.value)}
              />
              <SelectField
                label="Keying"
                value={lock.keying}
                options={keyingOptions}
                onChange={(e) => updateLock(lockIdx, 'keying', e.target.value)}
              />
              <SelectField
                label="Fire Rating"
                value={lock.fireRating}
                options={fireRatings}
                onChange={(e) => updateLock(lockIdx, 'fireRating', e.target.value)}
              />
              <SelectField
                label="ADA Compliance"
                value={lock.adaCompliance}
                options={adaOptions}
                onChange={(e) => updateLock(lockIdx, 'adaCompliance', e.target.value)}
              />
              <SelectField
                label="Lever Style"
                value={lock.leverStyle}
                options={leverStyles}
                onChange={(e) => updateLock(lockIdx, 'leverStyle', e.target.value)}
              />
            </div>
            <label className="block text-sm font-medium mb-1 mt-2">Notes</label>
            <textarea
              value={lock.notes}
              onChange={(e) => updateLock(lockIdx, 'notes', e.target.value)}
              placeholder="Additional Notes"
              className="border p-3 rounded w-full"
            />
            <button
              className="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
              onClick={() => deleteLock(lockIdx)}
            >
              Delete Lock
            </button>
          </div>
        ));

        // Optimize Room component
        const Room = memo(({ room, floorIdx, roomIdx, updateRoom, deleteRoom, copyRoom, roomRef }) => {
          const handleNameChange = useCallback((e) => {
            updateRoom({ ...room, name: e.target.value });
          }, [room, updateRoom]);

          const handleNameBlur = useCallback((e) => {
            const value = e.target.value.trim();
            updateRoom({ ...room, name: value || `Room ${roomIdx + 1}` });
          }, [room, roomIdx, updateRoom]);

          const handleNameFocus = useCallback(() => {
            updateRoom({ ...room, name: '' });
          }, [room, updateRoom]);

          const updateLocks = useCallback((updatedLocks) => {
            updateRoom({ ...room, locks: updatedLocks });
          }, [room, updateRoom]);

          return (
            <div ref={roomRef} className="ml-1 sm:ml-2 mb-4 p-2 sm:p-4 bg-gray-50 rounded shadow overflow-x-hidden">
              <div className="flex flex-col sm:flex-row items-start sm:items-center mb-2 gap-2 flex-wrap">
                <input
                  type="text"
                  value={room.name}
                  onFocus={handleNameFocus}
                  onBlur={handleNameBlur}
                  onChange={handleNameChange}
                  placeholder={`Room ${roomIdx + 1}`}
                  className="text-md font-semibold border p-3 rounded w-full sm:flex-1"
                />
                <div className="flex gap-2 w-full sm:w-auto">
                  <button
                    className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 active:bg-yellow-700"
                    onClick={copyRoom}
                  >
                    Copy Room
                  </button>
                  <button
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 active:bg-red-700"
                    onClick={deleteRoom}
                  >
                    Delete Room
                  </button>
                </div>
              </div>
              <LockDetails
                locks={room.locks}
                updateLocks={updateLocks}
              />
            </div>
          );
        });

        // Optimize Floor component
        const Floor = memo(({ floor, index, updateFloor, addRoom, deleteFloor, copyFloor, floorRef }) => {
          const roomRefs = useRef([]);
          
          useEffect(() => {
            // Initialize room refs only when needed
            if (roomRefs.current.length !== floor.rooms.length) {
              roomRefs.current = Array(floor.rooms.length).fill().map((_, i) => 
                roomRefs.current[i] || createRef()
              );
            }
          }, [floor.rooms.length]);

          const handleNameChange = useCallback((e) => {
            updateFloor({ ...floor, name: e.target.value });
          }, [floor, updateFloor]);

          const handleNameBlur = useCallback((e) => {
            const value = e.target.value.trim();
            updateFloor({ ...floor, name: value || `Floor ${index + 1}` });
          }, [floor, index, updateFloor]);

          const handleNameFocus = useCallback(() => {
            updateFloor({ ...floor, name: '' });
          }, [floor, updateFloor]);

          const updateRoom = useCallback((roomIdx, updatedRoom) => {
            const newRooms = [...floor.rooms];
            newRooms[roomIdx] = updatedRoom;
            updateFloor({ ...floor, rooms: newRooms });
          }, [floor, updateFloor]);

          const deleteRoom = useCallback((roomIdx, roomName) => {
            console.log(`Deleting room ${roomIdx} on floor ${index}`);
            if (window.confirm(`Delete ${roomName || `Room ${roomIdx + 1}`} and its contents?`)) {
              const newRooms = floor.rooms.filter((_, i) => i !== roomIdx);
              roomRefs.current = roomRefs.current.filter((_, i) => i !== roomIdx);
              updateFloor({ ...floor, rooms: newRooms });
            } else {
              console.log('Delete room cancelled');
            }
          }, [floor, index, updateFloor]);

          const copyRoomHandler = useCallback((roomIdx, roomName) => {
            console.log(`Copying room ${roomIdx} on floor ${index}`);
            if (window.confirm(`Copy ${roomName || `Room ${roomIdx + 1}`} and its contents?`)) {
              const newRooms = [...floor.rooms];
              newRooms.splice(roomIdx + 1, 0, { ...floor.rooms[roomIdx] });
              
              // Update refs array
              roomRefs.current.splice(roomIdx + 1, 0, createRef());
              updateFloor({ ...floor, rooms: newRooms });
              
              // Scroll to new room after render
              setTimeout(() => {
                if (roomRefs.current[roomIdx + 1]?.current) {
                  roomRefs.current[roomIdx + 1].current.scrollIntoView({ behavior: 'smooth' });
                }
              }, 10);
            } else {
              console.log('Copy room cancelled');
            }
          }, [floor, index, updateFloor]);

          return (
            <div ref={floorRef} className="mb-4 p-2 sm:p-4 bg-white rounded shadow overflow-x-hidden">
              <div className="flex flex-col sm:flex-row items-start sm:items-center mb-2 gap-2 flex-wrap">
                <input
                  type="text"
                  value={floor.name}
                  onFocus={handleNameFocus}
                  onBlur={handleNameBlur}
                  onChange={handleNameChange}
                  placeholder={`Floor ${index + 1}`}
                  className="text-lg font-bold border p-3 rounded w-full sm:flex-1"
                />
                <div className="flex gap-2 w-full sm:w-auto">
                  <button
                    className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 active:bg-yellow-700"
                    onClick={() => copyFloor(index)}
                  >
                    Copy Floor
                  </button>
                  <button
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 active:bg-red-700"
                    onClick={() => deleteFloor(index)}
                  >
                    Delete Floor
                  </button>
                </div>
              </div>
              <div className="overflow-auto">
                {floor.rooms.map((room, roomIdx) => (
                  <Room
                    key={`${index}-${roomIdx}`}
                    room={room}
                    floorIdx={index}
                    roomIdx={roomIdx}
                    updateRoom={(updatedRoom) => updateRoom(roomIdx, updatedRoom)}
                    deleteRoom={() => deleteRoom(roomIdx, room.name)}
                    copyRoom={() => copyRoomHandler(roomIdx, room.name)}
                    roomRef={roomRefs.current[roomIdx] || createRef()}
                  />
                ))}
              </div>
              <button
                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 w-full sm:w-auto"
                onClick={addRoom}
              >
                + Add Room
              </button>
            </div>
          );
        });

        // Export functionality
        const formatSurveyForEmail = (project) => {
          let csv = 'Quantity,Model,Location,Manufacturer,System,Custom Field 12\n';
          const equipmentRack = [];
          let totalDevices = 0;
          let audioStreams = 0;
          let totalZones = 0;
          let subAmps = 0;
          let controllerCount = 0;

          const deviceTypes = [
            'Dimmer', 'Switch', 'Keypad', 'Fan', 'Companion Dimmer', 'Companion Switch', 'Remote Keypad', 'Pico Remote'
          ];
          const colorCodes = {
            'White': 'WH', 'Light Almond': 'LA', 'Ivory': 'IV', 'Black': 'BL', 'Brilliant White': 'BW',
            'Glacier White': 'GL', 'Snow': 'SW', 'Architectural White': 'RW', 'Lunar Grey': 'LG', 'Mist': 'MI',
            'Pebble': 'PB', 'Cobblestone': 'CS', 'Biscuit': 'BI', 'Slate': 'SL', 'Sand': 'SD', 'Taupe': 'TP',
            'Pumice': 'PM', 'Clay': 'CY', 'Sage': 'SA', 'Espresso': 'EP', 'Truffle': 'TF', 'Deep Sea': 'DE',
            'Signal Red': 'SR', 'Midnight': 'MN'
          };
          const modelCodes = {
            'Switch': 'RRST-8ANS-XX',
            'Dimmer': 'RRST-PRO-N-XX',
            'Keypad': 'RRST-W4B-XX',
            'Fan': 'RRD-2ANF-XX',
            'Companion Dimmer': 'RRST-RD-XX',
            'Companion Switch': 'RRST-RS-XX',
            'Remote Keypad': 'RRST-W4B-XX',
            'Pico Remote': 'PJ2-4B-GWH-L31'
          };

          // Process locks data
          project.floors.forEach((floor, floorIdx) => {
            floor.rooms.forEach((room, roomIdx) => {
              const c4 = room.control4;
              totalDevices += c4.keypads?.length || 0;
              totalDevices += c4.touchscreens?.length || 0;
              totalDevices += c4.haloRemote?.enabled ? 1 : 0;
              totalDevices += c4.lights?.enabled ? c4.lights.count : 0;
              totalDevices += c4.shades?.length || 0;
              if (c4.videoStream?.enabled) totalDevices += 1;
              if (c4.roomAudio?.enabled) {
                audioStreams += 1;
                const dist = c4.roomAudio.distribution;
                const zones = dist === 'Mono' ? 1 : dist === 'Stereo' ? 2 : parseInt(dist.split('.')[0]) + (dist.includes('.1') || dist.includes('.2') ? 1 : 0);
                totalZones += zones;
                if (dist.includes('.1') || dist.includes('.2')) subAmps += 1;
                totalDevices += zones;
              }
              
              // Process lock data for each room
              if (room.locks?.enabled) {
                const floorName = floor.name || `Floor ${floorIdx + 1}`;
                const roomName = room.name || `Room ${roomIdx + 1}`;
                const location = `${floorName}: ${roomName}`;
                
                room.locks.locks.forEach((lock, lockIdx) => {
                  const lockName = lock.name || `Lock ${lockIdx + 1}`;
                  const lockLocation = `${location}: ${lockName}`;
                  const notes = [
                    `Handing: ${lock.handing}`,
                    `Lock Type: ${lock.lockType}`,
                    `Function: ${lock.lockFunction}`,
                    `Finish: ${lock.finish}`,
                    `Keyway: ${lock.keyway}`,
                    `Door Type: ${lock.doorType}`,
                    `Door Thickness: ${lock.doorThickness}`,
                    `Backset: ${lock.backset}`,
                    `Keying: ${lock.keying}`,
                    `Fire Rating: ${lock.fireRating}`,
                    `ADA Compliance: ${lock.adaCompliance}`,
                    `Lever Style: ${lock.leverStyle}`,
                    lock.notes
                  ].filter(Boolean).join('; ');
                  
                  csv += `1,${lock.lockType.replace(/\s+/g, '-')},"${lockLocation}",Generic,Lock System,"${notes}"\n`;
                });
              }
              
              // Process lighting data
              if (room.lighting?.banks) {
                room.lighting.banks.forEach((bank, bankIdx) => {
                  const floorName = floor.name || `Floor ${floorIdx + 1}`;
                  const roomName = room.name || `Room ${roomIdx + 1}`;
                  const bankName = bank.name || `Switch Bank ${bankIdx + 1}`;
                  const location = `${floorName}: ${roomName}: ${bankName}`;
                  
                  if (bank.devices) {
                    bank.devices.forEach((device, devIdx) => {
                      let model = modelCodes[device.type] || 'UNKNOWN';
                      if (device.type !== 'Pico Remote') {
                        model = model.replace('XX', colorCodes[bank.color] || 'WH');
                      }
                      const notes = device.notes ? `; Notes: ${device.notes}` : '';
                      csv += `1,${model},"${location}",Lutron,Lighting System,"Device ${devIdx + 1}: ${device.type}${notes}"\n`;
                    });
                  }
                });
              }
            });
          });

          // Process video stream rooms
          const videoStreamRooms = [];
          project.floors.forEach((floor, floorIdx) => {
            floor.rooms.forEach((room, roomIdx) => {
              if (room.control4?.videoStream?.enabled) {
                videoStreamRooms.push({ floorIdx, roomIdx });
              }
            });
          });
          
          totalDevices += videoStreamRooms.length;
          const needsCore5 = totalDevices > 45;
          const equipmentRoom = project.equipmentRoom;
          const equipmentRoomLocation = equipmentRoom ? 
            `${project.floors[equipmentRoom.floorIdx].name || `Floor ${equipmentRoom.floorIdx + 1}`}: ${project.floors[equipmentRoom.floorIdx].rooms[equipmentRoom.roomIdx].name || `Room ${equipmentRoom.roomIdx + 1}`}` : 
            'Equipment Rack';

          // Video stream controllers
          videoStreamRooms.forEach((room, idx) => {
            const { floorIdx, roomIdx } = room;
            const roomName = project.floors[floorIdx].rooms[roomIdx].name || `Room ${roomIdx + 1}`;
            const floorName = project.floors[floorIdx].name || `Floor ${floorIdx + 1}`;
            const location = `${floorName}: ${roomName}`;
            let model = 'EA-1';
            
            if (equipmentRoom && equipmentRoom.floorIdx === floorIdx && equipmentRoom.roomIdx === roomIdx) {
              model = needsCore5 ? 'EA-5' : 'EA-3';
            } else if (idx === 1 && !needsCore5) {
              model = 'EA-3';
            } else if (idx === 1 && needsCore5) {
              model = 'EA-1';
            }
            
            controllerCount += 1;
            csv += `1,${model},"${location}",Control4,Smart Home System,"Video Stream Controller"\n`;
          });

          // Equipment rack
          if (needsCore5 && (!equipmentRoom || !videoStreamRooms.some(r => r.floorIdx === equipmentRoom.floorIdx && r.roomIdx === equipmentRoom.roomIdx))) {
            equipmentRack.push({ model: 'EA-5', quantity: 1, ru: 2, notes: 'Core 5 Controller' });
            controllerCount += 1;
          }

          // Audio matrices
          if (audioStreams > 0) {
            if (audioStreams <= 8) {
              equipmentRack.push({ model: 'TS-AMS8-V2', quantity: 1, ru: 2, notes: '8x8 Audio Matrix' });
            } else if (audioStreams <= 16) {
              equipmentRack.push({ model: 'TS-AMS-16', quantity: 1, ru: 3, notes: '16x16 Audio Matrix' });
            }
