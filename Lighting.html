<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lighting Survey</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.1/dist/umd/uuid.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="root" className="min-h-screen bg-gray-100 p-2 sm:p-4"></div>
    <script type="text/babel">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
          if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
              var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
              var firstSheetName = workbook.SheetNames[0];
              var worksheet = workbook.Sheets[firstSheetName];
              var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
              var filteredData = jsonData.filter(row => row.some(filledCell));
              var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
              );
              if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
              }
              var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
              csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
              return csv;
            } catch (e) {
              console.error(e);
              return "";
            }
          }
          return gk_fileData[filename] || "";
        }

        const generateFallbackId = () => {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        };
        const uuidv4 = window.uuidv4 || generateFallbackId;

        const deviceTypes = [
          'Dimmer', 'Switch', 'Keypad', 'Fan', 'Companion Dimmer', 'Companion Switch', 'Remote Keypad', 'Pico Remote'
        ];
        const bankColors = [
          'White', 'Light Almond', 'Ivory', 'Black', 'Brilliant White', 'Glacier White', 'Snow',
          'Architectural White', 'Lunar Grey', 'Mist', 'Pebble', 'Cobblestone', 'Biscuit', 'Slate',
          'Sand', 'Taupe', 'Pumice', 'Clay', 'Sage', 'Espresso', 'Truffle', 'Deep Sea', 'Signal Red', 'Midnight'
        ];
        const colorCodes = {
          'White': 'WH', 'Light Almond': 'LA', 'Ivory': 'IV', 'Black': 'BL', 'Brilliant White': 'BW',
          'Glacier White': 'GL', 'Snow': 'SW', 'Architectural White': 'RW', 'Lunar Grey': 'LG', 'Mist': 'MI',
          'Pebble': 'PB', 'Cobblestone': 'CS', 'Biscuit': 'BI', 'Slate': 'SL', 'Sand': 'SD', 'Taupe': 'TP',
          'Pumice': 'PM', 'Clay': 'CY', 'Sage': 'SA', 'Espresso': 'EP', 'Truffle': 'TF', 'Deep Sea': 'DE',
          'Signal Red': 'SR', 'Midnight': 'MN'
        };
        const modelCodes = {
          'Switch': 'RRST-8ANS-XX',
          'Dimmer': 'RRST-PRO-N-XX',
          'Keypad': 'RRST-W4B-XX',
          'Fan': 'RRD-2ANF-XX',
          'Companion Dimmer': 'RRST-RD-XX',
          'Companion Switch': 'RRST-RS-XX',
          'Remote Keypad': 'RRST-W4B-XX',
          'Pico Remote': 'PJ2-4B-GWH-L31'
        };

        const Floor = ({ floor, index, updateFloor, addRoom, deleteFloor, copyFloor, floorRef }) => {
          const roomRefs = React.useRef([]);
          React.useEffect(() => {
            roomRefs.current[index] = roomRefs.current[index] || Array(floor.rooms.length).fill().map(() => React.createRef());
          }, [index, floor.rooms.length]);

          return (
            <div ref={floorRef} className="mb-4 p-2 sm:p-4 bg-white rounded shadow overflow-x-hidden">
              <div className="flex flex-col sm:flex-row items-start sm:items-center mb-2 gap-2 flex-wrap">
                <input
                  type="text"
                  value={floor.name}
                  onFocus={() => updateFloor({ ...floor, name: '' })}
                  onBlur={(e) => {
                    const value = e.target.value.trim();
                    updateFloor({ ...floor, name: value || `Floor ${index + 1}` });
                  }}
                  onChange={(e) => updateFloor({ ...floor, name: e.target.value })}
                  placeholder={`Floor ${index + 1}`}
                  className="text-lg font-bold border p-3 rounded w-full sm:flex-1"
                />
                <div className="flex gap-2 w-full sm:w-auto">
                  <button
                    className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 active:bg-yellow-700"
                    onClick={() => {
                      console.log(`Copying floor ${index}`);
                      copyFloor(index);
                    }}
                  >
                    Copy Floor
                  </button>
                  <button
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 active:bg-red-700"
                    onClick={() => {
                      console.log(`Deleting floor ${index}`);
                      deleteFloor(index);
                    }}
                  >
                    Delete Floor
                  </button>
                </div>
              </div>
              <div className="overflow-auto">
                {floor.rooms.map((room, roomIdx) => (
                  <Room
                    key={roomIdx}
                    room={room}
                    floorIdx={index}
                    roomIdx={roomIdx}
                    updateRoom={(updatedRoom) => {
                      const newRooms = [...floor.rooms];
                      newRooms[roomIdx] = updatedRoom;
                      updateFloor({ ...floor, rooms: newRooms });
                    }}
                    deleteRoom={() => {
                      console.log(`Deleting room ${roomIdx} on floor ${index}`);
                      if (window.confirm(`Delete ${room.name || `Room ${roomIdx + 1}`} and its contents?`)) {
                        const newRooms = floor.rooms.filter((_, i) => i !== roomIdx);
                        roomRefs.current[index].splice(roomIdx, 1);
                        updateFloor({ ...floor, rooms: newRooms });
                      } else {
                        console.log('Delete room cancelled');
                      }
                    }}
                    copyRoom={() => {
                      console.log(`Copying room ${roomIdx} on floor ${index}`);
                      if (window.confirm(`Copy ${room.name || `Room ${roomIdx + 1}`} and its contents?`)) {
                        const newRooms = [...floor.rooms];
                        newRooms.splice(roomIdx + 1, 0, { ...room });
                        roomRefs.current[index].splice(roomIdx + 1, 0, React.createRef());
                        updateFloor({ ...floor, rooms: newRooms });
                        setTimeout(() => {
                          if (roomRefs.current[index][roomIdx + 1]?.current) {
                            roomRefs.current[index][roomIdx + 1].current.scrollIntoView({ behavior: 'smooth' });
                          }
                        }, 0);
                      } else {
                        console.log('Copy room cancelled');
                      }
                    }}
                    roomRef={roomRefs.current[index]?.[roomIdx] || React.createRef()}
                  />
                ))}
              </div>
              <button
                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 w-full sm:w-auto"
                onClick={addRoom}
              >
                + Add Room
              </button>
            </div>
          );
        };

        const Room = ({ room, floorIdx, roomIdx, updateRoom, deleteRoom, copyRoom, roomRef }) => (
          <div ref={roomRef} className="ml-1 sm:ml-2 mb-4 p-2 sm:p-4 bg-gray-50 rounded shadow overflow-x-hidden">
            <div className="flex flex-col sm:flex-row items-start sm:items-center mb-2 gap-2 flex-wrap">
              <input
                type="text"
                value={room.name}
                onFocus={() => updateRoom({ ...room, name: '' })}
                onBlur={(e) => {
                  const value = e.target.value.trim();
                  updateRoom({ ...room, name: value || `Room ${roomIdx + 1}` });
                }}
                onChange={(e) => updateRoom({ ...room, name: e.target.value })}
                placeholder={`Room ${roomIdx + 1}`}
                className="text-md font-semibold border p-3 rounded w-full sm:flex-1"
              />
              <div className="flex gap-2 w-full sm:w-auto">
                <button
                  className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 active:bg-yellow-700"
                  onClick={() => {
                    console.log(`Copying room ${roomIdx} on floor ${floorIdx}`);
                    copyRoom();
                  }}
                >
                  Copy Room
                </button>
                <button
                  className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 active:bg-red-700"
                  onClick={() => {
                    console.log(`Deleting room ${roomIdx} on floor ${floorIdx}`);
                    deleteRoom();
                  }}
                >
                  Delete Room
                </button>
              </div>
            </div>
            <div className="overflow-auto">
              {room.lighting.banks.map((bank, bankIdx) => (
                <SwitchBank
                  key={bankIdx}
                  bank={bank}
                  floorIdx={floorIdx}
                  roomIdx={roomIdx}
                  bankIdx={bankIdx}
                  updateBank={(updatedBank) => {
                    const newBanks = [...room.lighting.banks];
                    newBanks[bankIdx] = updatedBank;
                    updateRoom({ ...room, lighting: { ...room.lighting, banks: newBanks } });
                  }}
                  deleteBank={() => {
                    console.log(`Deleting bank ${bankIdx} in room ${roomIdx} on floor ${floorIdx}`);
                    if (window.confirm(`Delete ${bank.name || `Switch Bank ${bankIdx + 1}`}?`)) {
                      const newBanks = room.lighting.banks.filter((_, i) => i !== bankIdx);
                      updateRoom({ ...room, lighting: { ...room.lighting, banks: newBanks } });
                    } else {
                      console.log('Delete bank cancelled');
                    }
                  }}
                  copyBank={() => {
                    console.log(`Copying bank ${bankIdx} in room ${roomIdx} on floor ${floorIdx}`);
                    if (window.confirm(`Copy ${bank.name || `Switch Bank ${bankIdx + 1}`}?`)) {
                      const newBanks = [...room.lighting.banks];
                      newBanks.splice(bankIdx + 1, 0, { ...bank });
                      updateRoom({ ...room, lighting: { ...room.lighting, banks: newBanks } });
                    } else {
                      console.log('Copy bank cancelled');
                    }
                  }}
                />
              ))}
            </div>
            <button
              className="mt-2 bg-blue-400 text-white px-3 py-1 rounded hover:bg-blue-500 w-full sm:w-auto"
              onClick={() => updateRoom({ ...room, lighting: { ...room.lighting, banks: [...room.lighting.banks, { devices: [], name: '', color: 'White' }] } })}
            >
              + Add Switch Bank
            </button>
          </div>
        );

        const SwitchBank = ({ bank, floorIdx, roomIdx, bankIdx, updateBank, deleteBank, copyBank }) => (
          <div className="ml-1 sm:ml-2 mb-4 p-2 sm:p-4 bg-gray-100 rounded overflow-x-hidden">
            <div className="flex flex-col sm:flex-row items-start sm:items-center mb-2 gap-2 flex-wrap">
              <input
                type="text"
                value={bank.name}
                onFocus={() => updateBank({ ...bank, name: '' })}
                onBlur={(e) => {
                  const value = e.target.value.trim();
                  updateBank({ ...bank, name: value || `Switch Bank ${bankIdx + 1}` });
                }}
                onChange={(e) => updateBank({ ...bank, name: e.target.value })}
                placeholder={`Switch Bank ${bankIdx + 1}`}
                className="text-sm font-medium border p-3 rounded w-full sm:flex-1"
              />
              <select
                value={bank.color}
                onChange={(e) => updateBank({ ...bank, color: e.target.value })}
                className="border p-3 rounded w-full sm:w-40"
                disabled={bank.devices.some(device => device.type === 'Pico Remote')}
              >
                {bankColors.map((color) => (
                  <option key={color} value={color}>{color}</option>
                ))}
              </select>
              <div className="flex gap-2 w-full sm:w-auto">
                <button
                  className="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 active:bg-yellow-700"
                  onClick={() => {
                    console.log(`Copying bank ${bankIdx} in room ${roomIdx} on floor ${floorIdx}`);
                    copyBank();
                  }}
                >
                  Copy Bank
                </button>
                <button
                  className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 active:bg-red-700"
                  onClick={()
